name: Daily Crawler

on:
  workflow_dispatch:       # 수동 실행 활성화
  schedule:                # 매일 UTC 23시 = 한국 시간 오전 8시
    - cron: '0 23 * * *'

jobs:
  crawl:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    - name: Install dependencies
      run: pip install -r requirements.txt

    - name: Set up environment variables
      run: |
        echo "SUPABASE_URL=${{ secrets.SUPABASE_URL }}" >> $GITHUB_ENV
        echo "SUPABASE_KEY=${{ secrets.SUPABASE_KEY }}" >> $GITHUB_ENV
        echo "SMTP_USER=${{ secrets.SMTP_USER }}" >> $GITHUB_ENV
        echo "SMTP_PASSWORD=${{ secrets.SMTP_PASSWORD }}" >> $GITHUB_ENV
        echo "RECIPIENT_EMAIL=${{ secrets.RECIPIENT_EMAIL }}" >> $GITHUB_ENV

    - name: Install Chrome 114 and matching ChromeDriver
      run: |
        sudo apt-get update
        sudo apt-get install -y wget unzip curl gnupg2

        # 구버전 크롬 설치를 위한 PPA 등록
        wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
        echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list

        sudo apt-get update

        # 크롬 114 강제 설치
        sudo apt-get install -y google-chrome-stable=114.0.5735.133-1 || echo "Chrome 114 강제 설치 실패: 수동 다운로드 필요할 수 있음"

        # 크롬드라이버 114 수동 설치
        wget https://chromedriver.storage.googleapis.com/114.0.5735.90/chromedriver_linux64.zip
        unzip chromedriver_linux64.zip
        sudo mv chromedriver /usr/local/bin/
        chmod +x /usr/local/bin/chromedriver

        # 버전 확인
        google-chrome --version || true
        chromedriver --version || true

    - name: Run crawler
      run: python aitimes_crawler.py
